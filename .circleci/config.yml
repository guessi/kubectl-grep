version: 2.1

references:
  default_setup: &default_setup
    docker:
      - image: cimg/go:1.16
    resource_class: medium
    working_directory: /home/circleci/project

  filter_tag_only: &filter_tag_only
    filters:
      tags:
        only:
          - /^v[0-9]+\.[0-9]+\.[0-9]+/
      branches:
        ignore: /.*/

jobs:
  bootstrap:
    <<: *default_setup
    steps:
      - checkout
      - run:
          name: Setup Dependencies
          command: make dependency
      - save_cache:
          key: v1-16-{{ checksum "go.mod" }}-source-ng
          paths:
            - /home/circleci/go/pkg/mod
  lint:
    <<: *default_setup
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-16-{{ checksum "go.mod" }}-source-ng
      - run:
          name: Setup Utilities
          command: make utilities
      - run:
          name: Run tests
          command: make test
      - run:
          name: Code Lint
          command: make lint
  build:
    <<: *default_setup
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-16-{{ checksum "go.mod" }}-source-ng
      - run:
          name: Build Code
          command: make
      - save_cache:
          key: v1-16-{{ .Environment.CIRCLE_SHA1 }}-workspace-ng
          paths:
            - /home/circleci/project
  release:
    <<: *default_setup
    steps:
      - restore_cache:
          keys:
            - v1-16-{{ .Environment.CIRCLE_SHA1 }}-workspace-ng
            - v1-16-{{ checksum "go.mod" }}-source-ng
      - run:
          name: Release
          command: make release
      - run:
          name: Krew Release Bot
          command: make krew-release-bot

workflows:
  version: 2
  nightly:
    triggers:
      - schedule:
          cron: "0 3 * * *"
          filters:
            branches:
              only:
                - master
    jobs:
      - bootstrap
      - lint:
          requires:
            - bootstrap
      - build:
          requires:
            - lint
  main-workflow:
    jobs:
      - bootstrap
      - lint:
          requires:
            - bootstrap
      - build:
          requires:
            - lint
  release-workflow:
    jobs:
      - bootstrap:
          <<: *filter_tag_only
      - lint:
          requires:
            - bootstrap
          <<: *filter_tag_only
      - build:
          requires:
            - lint
          <<: *filter_tag_only
      - release:
          requires:
            - build
          <<: *filter_tag_only
